---
layout:     post
title:    一次虚假的“反制”
subtitle:   虚假的反制
date:       2020-10-18
author:     hmoytx
header-img: img/bg_02.jpg
catalog: true
tags:
    - 溯源反制
    - 渗透测试
---
# 一次虚假的“反制””

## 前言
大型交友活动来完就是地方小型交友（不应该反一下么？），不能空手交上去，想着挑一些好写的ip写点内容，但压根就没有啥告警量，马都没了。  
庆幸的是有那么一个ip好像能冲一下，冲完了放最后一天交，不指望能拿分，用脚指头想都知道不是他们攻击队的。再来加分不加分跟我p关系也没有，我就是个搬砖的，交了没损失。

## 再废话几句
说是反制，个人觉得加个引号可能更好。不管对面是真正的攻击队，还是抓鸡阔也好，对于防守方来说不可能知道那么清楚，但是很多时候都是硬着头皮写，大型真人交友击剑活动中看过几份“溯源反制”报告，都是一样的套路，拿下来后就是讲故事环节，个中逻辑多有些牵强与混乱，最后当然能拿的分也没有想象中的那么多。但是只要有加分的可能，还是要试试。   
此类攻击IP，一般都为VPS，服务器(至少我这里都是)。此类IP就没必要再去进行所谓定位，无论你怎么定位都是知道省（直辖市），地级市中心。看到过一份报告中，对一VPS进行了定位，帝都的IP，而定位平台默认定在中心，tam广场附近，而广场附近恰好又为某部委，依次作为推断，简直令人啼笑皆非（dio都笑歪）。然后再进行端口服务探测，此类服务器一般都是存在薄弱环节，能较容易获取权限，多为phpmyadmin弱口令，框架漏洞，中间件漏洞命令执行，未授权访问等。剩下的就是信息获取，证据收集和整理输出的过程。  
附一个自己整的案例，只能说没有查到什么，不指望加分，但是小交友评分较为诡异，按照溯源到身份信息最低标准500+主机权限500给了分，属实荒唐。  

## 发现告警
与其说是发现告警不如说是筛选攻击IP，一堆IP中只有一个是云服务器的。  
攻击形式就是扫描，命令执行漏洞利用。  
[201018_1](/img/201018_log.png)  
## 信息收集
然后进行端口信息收集，我没扫出来，然后再用fofa等引擎查找下，发现存在一个8983端口，查了下是solr，心想可能成功一半了。  
[201018_2](/img/201018_fofa.png)  
## 利用
尝试访问，一看的确为solr，那稳了，发车。  
[201018_3](/img/201018_solr.png)  
RCE显然存在，直接可以执行命令，且为system权限。  
[201018_4](/img/201018_rce.png)  
还发现了一个目录遍历，任意文件读取。发现其用户桌面存在远程连接文件。  
[201018_5](/img/201018_fileread.png)  
还发现桌面存在一些csv文件。下载后查看，为医疗相关的数据。服务器应该是沦陷后的肉鸡。    
[201018_6](/img/201018_data.png)  
## 上线
测试了下，出网，且未装防护软件，发现有些命令会返回500，为了操作方便使用cs上线(msf也行,并非一定要cs)。    
[201018_7](/img/201018_cs.png)    
尝试找出真实攻击者IP，首相想通过web访问日志来分析，怎么找都没找到就离谱，后来发现，log4j中将http记录给关了，剩下在系统目录中找到的httperror.log中的IP意义不大。  
[201018_8](/img/201018_log4j.png)    
想通过windows事件日志来获取IP，使用powershell来查询日志（能不远程桌面就不远程桌面，后来发现这就是我sb的地方）。  
[201018_9](/img/201018_getIP.png)  
显然失败了，我已经开始暴躁了，添加用户想直接登录桌面去看日志了。这时候发现，3389并未对外开放，我开始怀疑我前一步真的有意义么？想了想就当凑字数吧。不对外开放就直接用cs开socks进去。  
[201018_10](/img/201018_socks.png)   
进去以后因为是新建的账户，桌面是没有的，想看别人桌面也容易，一般就两种方法：注册表里复制修改SAM子项目键值，或者在system权限下使用tscon。  
我发现存在一个在线未注销账户，所以这里选用了后者，进入桌面使用之前写的工具开了一个system权限的cmd，tscon直接切过去。  
[201018_11](/img/201018_desktop.png)  
查了日志发现，只有当天的，可能是被处理过了，那线索就断了，看着桌面远程连接的，考虑对内网再进行进一步的渗透时，我被一脚蹬出去了。  
再过了会就下线了，服务器关机了。我没了。   

## 总结
反制过程本身也是一个红队过程，只是侧重的技术面会有区别，更多不在技术，在于关联分析。  
进行这个过程也是要谨慎，你不知道对面的是不是红队的蜜罐，是否有人正常在使用。你的每一步是否真的必要，是否会造成暴露而丢失权限，从而失去更多线索，这都是要仔细考虑的。  



